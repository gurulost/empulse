import{b as f,r as k,w as X,e as o,f as n,g as a,j as I,m as b,l as M,B as ve,G as be,F as D,y as z,A as te,o as fe,q as O,x as se,z as pe,I as le,D as ae}from"./vendor-vue-B_7dnjM8.js";import{a as K}from"./vendor-axios-B9ygI19o.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{S as Q}from"./SkeletonLoader-CW1uc0DJ.js";import{u as ye}from"./useToast-BhPLCSCb.js";const he={class:"mb-4"},ge={class:"form-label text-dark fw-bold mb-2 d-block"},xe={key:0,class:"text-muted small mb-3"},_e={key:1,class:"bg-light p-4 rounded-3 border-0"},we={class:"d-flex justify-content-between text-muted small fw-bold text-uppercase mb-3"},ke={key:0},Ve=["min","max","step","disabled"],qe={class:"d-flex justify-content-center mt-3"},Se={class:"badge bg-primary rounded-pill px-3 py-2 fs-6 shadow-sm"},$e=["type","value","disabled"],je=["value","disabled"],Ae=["value","disabled","min"],Ie=["value","disabled"],Pe=["value"],Te={key:0,class:"mt-3"},Ne=["placeholder","value","disabled"],Ce={key:6,class:"d-flex flex-column gap-2"},Ee=["id","value","checked","disabled","onChange"],Oe=["for"],Ue=["value","disabled"],Me={key:8,class:"alert alert-danger border-0 bg-danger bg-opacity-10 text-danger d-flex align-items-center mt-2 py-2 px-3 rounded-3"},De={__name:"SurveyItem",props:{item:{type:Object,required:!0},modelValue:{default:null},error:{type:String,default:""},disabled:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(m,{emit:F}){const u=m,V=F,g=f(()=>u.item.options||[]),N=f(()=>{const e={min:1,max:5,step:1};return u.item.scale?{...e,...u.item.scale}:e}),P=f(()=>{var e,l,h;return{left:((e=u.item.scale)==null?void 0:e.left_label)??"Low",right:((l=u.item.scale)==null?void 0:l.right_label)??"High",mid:((h=u.item.scale)==null?void 0:h.mid_label)??null}}),q=k(p());X(()=>u.modelValue,e=>{u.item.type==="slider"&&e!==void 0&&e!==null&&e!==""&&(q.value=Number(e))}),X(()=>q.value,e=>{u.item.type==="slider"&&V("update:modelValue",e)});function p(){if(u.modelValue!==null&&u.modelValue!==void 0)return Number(u.modelValue);const e=N.value.min??1,l=N.value.max??5;return Math.round((e+l)/2)}const x=f(()=>u.modelValue??""),_=f(()=>u.modelValue??""),$=f(()=>{var e;return((e=u.item.response)==null?void 0:e.format_hint)==="email"?"email":"text"}),L=f(()=>{var l;const e=(l=u.item.response)==null?void 0:l.min;return Number.isFinite(Number(e))?Number(e):void 0}),y=f(()=>u.item.type==="single_select_text"&&u.modelValue&&typeof u.modelValue=="object"?u.modelValue.selected??"":u.modelValue??""),C=f(()=>u.item.type==="single_select_text"&&u.modelValue&&typeof u.modelValue=="object"?u.modelValue.text??"":""),T=e=>Object.prototype.hasOwnProperty.call((e==null?void 0:e.meta)??{},"freetext_placeholder"),H=f(()=>{var h;const e=g.value.find(r=>r.value===y.value);if(!T(e))return"Please specify";const l=(h=e.meta)==null?void 0:h.freetext_placeholder;return l===""?"Please specify":l??"Please specify"}),G=f(()=>{const e=g.value.find(l=>l.value===y.value);return u.item.type==="single_select_text"&&T(e)}),j=f(()=>Array.isArray(u.modelValue)?u.modelValue:[]),E=f(()=>g.value.filter(e=>e.exclusive).map(e=>e.value)),R=e=>V("update:modelValue",e),Z=e=>{V("update:modelValue",e===""?null:Number(e))},W=e=>{var l;if(u.item.type==="single_select_text"){const h=g.value.find(r=>r.value===e);T(h)?V("update:modelValue",{selected:e,text:((l=u.modelValue)==null?void 0:l.text)??""}):V("update:modelValue",e)}else V("update:modelValue",e)},J=e=>{V("update:modelValue",{selected:y.value,text:e})},Y=e=>{const l=Array.isArray(u.modelValue)?[...u.modelValue]:[],h=l.includes(e.value);let r;e.exclusive?r=h?[]:[e.value]:(r=l.filter(U=>!E.value.includes(U)),h?r=r.filter(U=>U!==e.value):r.push(e.value)),V("update:modelValue",r)};return(e,l)=>{var h;return n(),o("div",he,[a("label",ge,b(m.item.question),1),(h=m.item.metadata)!=null&&h.note?(n(),o("p",xe,[l[7]||(l[7]=a("i",{class:"bi bi-info-circle me-1"},null,-1)),M(" "+b(m.item.metadata.note),1)])):I("",!0),m.item.type==="slider"?(n(),o("div",_e,[a("div",we,[a("span",null,b(P.value.left),1),P.value.mid?(n(),o("span",ke,b(P.value.mid),1)):I("",!0),a("span",null,b(P.value.right),1)]),ve(a("input",{type:"range",class:"form-range custom-range",min:N.value.min,max:N.value.max,step:N.value.step||1,"onUpdate:modelValue":l[0]||(l[0]=r=>q.value=r),disabled:m.disabled},null,8,Ve),[[be,q.value,void 0,{number:!0}]]),a("div",qe,[a("span",Se," Selected: "+b(q.value),1)])])):m.item.type==="text_short"||m.item.type==="text"?(n(),o("input",{key:2,type:$.value,class:"form-control form-control-lg shadow-sm",value:x.value,disabled:m.disabled,onInput:l[1]||(l[1]=r=>R(r.target.value)),placeholder:"Type your answer here..."},null,40,$e)):m.item.type==="text_long"?(n(),o("textarea",{key:3,class:"form-control form-control-lg shadow-sm",rows:"4",value:x.value,disabled:m.disabled,onInput:l[2]||(l[2]=r=>R(r.target.value)),placeholder:"Type your answer here..."},null,40,je)):m.item.type==="number_integer"?(n(),o("input",{key:4,type:"number",class:"form-control form-control-lg shadow-sm",value:_.value,disabled:m.disabled,min:L.value,step:"1",onInput:l[3]||(l[3]=r=>Z(r.target.value)),placeholder:"0"},null,40,Ae)):m.item.type==="dropdown"||m.item.type==="single_select"||m.item.type==="single_select_text"?(n(),o(D,{key:5},[a("select",{class:"form-select form-select-lg shadow-sm",value:y.value,disabled:m.disabled,onChange:l[4]||(l[4]=r=>W(r.target.value))},[l[8]||(l[8]=a("option",{value:"",disabled:""},"Select an option",-1)),(n(!0),o(D,null,z(g.value,r=>(n(),o("option",{key:r.value,value:r.value},b(r.label),9,Pe))),128))],40,Ie),G.value?(n(),o("div",Te,[a("input",{type:"text",class:"form-control form-control-lg shadow-sm",placeholder:H.value,value:C.value,disabled:m.disabled,onInput:l[5]||(l[5]=r=>J(r.target.value))},null,40,Ne)])):I("",!0)],64)):m.item.type==="multi_select"?(n(),o("div",Ce,[(n(!0),o(D,null,z(g.value,r=>(n(),o("div",{key:r.value,class:"form-check custom-checkbox p-3 border rounded-3 bg-white shadow-sm hover-bg transition-all"},[a("input",{class:"form-check-input me-2",type:"checkbox",id:m.item.qid+"-"+r.value,value:r.value,checked:j.value.includes(r.value),disabled:m.disabled,onChange:U=>Y(r),style:{transform:"scale(1.2)"}},null,40,Ee),a("label",{class:"form-check-label w-100 stretched-link",for:m.item.qid+"-"+r.value,style:{cursor:"pointer"}},b(r.label),9,Oe)]))),128))])):(n(),o("input",{key:7,type:"text",class:"form-control form-control-lg shadow-sm",value:x.value,disabled:m.disabled,onInput:l[6]||(l[6]=r=>R(r.target.value))},null,40,Ue)),m.error?(n(),o("div",Me,[l[9]||(l[9]=a("i",{class:"bi bi-exclamation-circle-fill me-2"},null,-1)),M(" "+b(m.error),1)])):I("",!0)])}}},re=ne(De,[["__scopeId","data-v-223d0388"]]),Fe={class:"survey-container mx-auto",style:{"max-width":"800px"}},Le={class:"text-center py-5",key:"loading"},Re={class:"card border-0 shadow-sm rounded-4 p-5"},Be={class:"d-flex justify-content-center gap-3"},Qe={class:"alert alert-danger shadow-sm border-0 rounded-3",key:"error"},ze={key:"completed"},He={class:"card border-0 shadow-lg rounded-4 overflow-hidden"},Je={class:"card-body text-center py-5 px-4"},Ye={key:0,class:"text-muted mb-4 lead"},Ge={key:1,class:"text-muted mb-4 lead"},We={key:"survey"},Ke={class:"mb-4 px-1"},Xe={class:"d-flex justify-content-between text-muted small mb-2 fw-semibold"},Ze={class:"progress",style:{height:"6px","background-color":"#e9ecef"}},et={class:"card border-0 shadow-lg rounded-4"},tt={class:"card-body p-4 p-md-5"},st={class:"mb-4 border-bottom pb-3"},lt={class:"h4 fw-bold mb-2 text-primary"},at={key:0,class:"text-muted mb-0"},rt={key:0,class:"survey-content"},nt={class:"mb-4"},ot={key:0,class:"h5 fw-bold mb-3 text-dark"},it={class:"d-flex justify-content-between align-items-center mt-5 pt-3 border-top"},ut=["disabled"],dt={class:"d-flex align-items-center gap-3"},ct={class:"d-none d-md-block text-end me-2"},mt={key:0,class:"text-muted d-block lh-1"},vt={key:1,class:"text-muted d-block lh-1"},bt={key:2,class:"text-danger d-block lh-1"},ft=["disabled"],pt=["disabled"],yt={key:0,class:"spinner-border spinner-border-sm me-2",role:"status"},ht={__name:"SurveyApp",props:{definitionUrl:{type:String,required:!0},submitUrl:{type:String,required:!0},autosaveUrl:{type:String,required:!0}},setup(m){const F=m,u=ye(),V=k(!0),g=k(null),N=k(null),P=k(null),q=k([]),p=k(0),x=te({}),_=te({}),$=k({status:"idle",timestamp:null}),L=k(null),y=k(!1),C=k(!1),T=k(!1),H=k(!1),G=Date.now(),j=f(()=>q.value[p.value]??null),E=f(()=>q.value.length),R=f(()=>p.value===E.value-1);fe(async()=>{V.value=!0,g.value=null;try{const{data:s}=await K.get(F.definitionUrl);N.value=s.version,P.value=s.assignment,q.value=s.pages||[],p.value=0,T.value=P.value.status==="completed",C.value=T.value,Object.keys(x).forEach(d=>delete x[d]);const t=P.value.draft_answers||{};Object.entries(t).forEach(([d,w])=>{x[d]=w}),H.value=!0}catch(s){console.error(s),g.value="Unable to load the survey right now. Please try again later.",u.error("Failed to load survey data.")}finally{V.value=!1}}),X(x,()=>{!H.value||C.value||W()},{deep:!0});const W=()=>{clearTimeout(L.value),L.value=setTimeout(async()=>{try{$.value={status:"saving",timestamp:null},await K.post(F.autosaveUrl,{responses:J()}),$.value={status:"saved",timestamp:new Date().toLocaleTimeString()}}catch(s){console.error("Autosave failed",s),$.value={status:"error",timestamp:null},u.error("Autosave failed. Please check your connection.")}},1e3)},J=()=>JSON.parse(JSON.stringify(x)),Y=(s,t)=>{x[s]=t,_[s]=null},e=(s=[])=>s.filter(t=>l(t)),l=s=>{const t=s.display_logic;if(!t||Array.isArray(t)&&t.length===0)return!0;const d=Array.isArray(t)?t:t.when??[];if(!d.length)return!0;const w=c=>{const v=x[c.qid];if(v==null||v==="")return!1;const S=c.equals_any||[];if(!S.length)return!0;if(Array.isArray(v))return v.some(A=>S.includes(A));if(typeof v=="object"){const A=v.selected??v.value??v.text??"";return S.includes(A)}return S.includes(v)},i=String((t==null?void 0:t.operator)??(t==null?void 0:t.combinator)??"and").toLowerCase();return i==="or"||i==="any"?d.some(w):d.every(w)},h=s=>{var t;return((t=s==null?void 0:s.response)==null?void 0:t.required)!==!1&&["slider","single_select","single_select_text","dropdown","multi_select","number_integer","text_short","text","text_long"].includes(s.type)},r=s=>s==null||s===""?!0:Array.isArray(s)?s.length===0:typeof s=="object"?Object.keys(s).filter(d=>s[d]!==void 0&&s[d]!=="").length===0:!1,U=s=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s).trim()),oe=s=>{var d;const t=(d=s==null?void 0:s.response)==null?void 0:d.min;return Number.isFinite(Number(t))?Number(t):null},ie=()=>{const s=[];return(q.value||[]).forEach(t=>{e(t.items||[]).forEach(d=>s.push(d.qid)),(t.sections||[]).forEach(d=>{e(d.items||[]).forEach(w=>s.push(w.qid))})}),new Set(s)},ue=()=>{const s=J(),t=ie();return Object.fromEntries(Object.entries(s).filter(([d])=>t.has(d)))},ee=()=>{const s=j.value;if(!s)return!0;let t=!0;const d=(s.sections||[]).flatMap(i=>e(i.items||[]));return[...e(s.items||[]),...d].forEach(i=>{var v;const c=x[i.qid];if(h(i)&&r(c)){_[i.qid]="Please provide an answer.",t=!1;return}if(i.type==="single_select_text"&&c&&typeof c=="object"&&c.selected&&(!c.text||String(c.text).trim()==="")){_[i.qid]="Please provide the additional text.",t=!1;return}if((i.type==="text_short"||i.type==="text"||i.type==="text_long")&&((v=i==null?void 0:i.response)==null?void 0:v.format_hint)==="email"&&!r(c)&&!U(c)){_[i.qid]="Please enter a valid email address.",t=!1;return}if(i.type==="number_integer"&&!r(c)){const S=Number(c);if(!Number.isInteger(S)){_[i.qid]="Please enter a whole number.",t=!1;return}const A=oe(i);if(A!==null&&S<A){_[i.qid]=`Value must be at least ${A}.`,t=!1;return}}_[i.qid]=null}),t},de=()=>{p.value===0||y.value||(p.value-=1)},ce=()=>{!ee()||y.value||p.value<E.value-1&&(p.value+=1)},me=async()=>{var s,t;if(ee()){y.value=!0,g.value=null,clearTimeout(L.value);try{await K.post(F.submitUrl,{responses:ue(),duration_ms:Date.now()-G}),C.value=!0}catch(d){if(d.response&&d.response.status===409)C.value=!0,T.value=!0;else if(d.response&&d.response.status===422){const w=((t=(s=d.response)==null?void 0:s.data)==null?void 0:t.errors)||{};Object.keys(_).forEach(c=>{_[c]=null}),Object.entries(w).forEach(([c,v])=>{const S=Array.isArray(v)?v[0]:v;_[c]=S||"Invalid answer."});const i=Object.keys(w)[0];if(i){const c=q.value.findIndex(v=>{const S=e(v.items||[]).map(B=>B.qid),A=(v.sections||[]).flatMap(B=>e(B.items||[])).map(B=>B.qid);return[...S,...A].includes(i)});c>=0&&(p.value=c)}g.value="Please correct the highlighted responses and submit again."}else console.error(d),g.value="Something went wrong while submitting your responses. Please try again."}finally{y.value=!1}}};return(s,t)=>(n(),o("div",Fe,[O(le,{name:"fade",mode:"out-in"},{default:se(()=>[V.value?(n(),o("div",Le,[a("div",Re,[O(Q,{height:"2rem",width:"60%",class:"mb-4 mx-auto"}),O(Q,{height:"1rem",width:"80%",class:"mb-2 mx-auto"}),O(Q,{height:"1rem",width:"70%",class:"mb-4 mx-auto"}),a("div",Be,[O(Q,{height:"3rem",width:"120px",borderRadius:"2rem"}),O(Q,{height:"3rem",width:"120px",borderRadius:"2rem"})])])])):g.value?(n(),o("div",Qe,[t[0]||(t[0]=a("i",{class:"bi bi-exclamation-circle-fill me-2"},null,-1)),M(" "+b(g.value),1)])):C.value?(n(),o("div",ze,[a("div",He,[a("div",Je,[t[1]||(t[1]=a("div",{class:"mb-4"},[a("div",{class:"bg-success bg-opacity-10 text-success rounded-circle d-inline-flex align-items-center justify-content-center",style:{width:"80px",height:"80px"}},[a("i",{class:"bi bi-check-lg display-4"})])],-1)),t[2]||(t[2]=a("h1",{class:"h3 fw-bold mb-3"},"Thank you!",-1)),T.value?(n(),o("p",Ye," You have already submitted this survey. We appreciate your time. ")):(n(),o("p",Ge," Your responses have been recorded successfully. ")),t[3]||(t[3]=a("a",{href:"/",class:"btn btn-primary rounded-pill px-4 py-2"},"Return to Home",-1))])])])):(n(),o("div",We,[a("div",Ke,[a("div",Xe,[a("span",null,"Page "+b(p.value+1)+" of "+b(E.value),1),a("span",null,b(Math.round((p.value+1)/E.value*100))+"% Completed",1)]),a("div",Ze,[a("div",{class:"progress-bar bg-primary rounded-pill",role:"progressbar",style:pe({width:`${(p.value+1)/E.value*100}%`})},null,4)])]),a("div",et,[a("div",tt,[O(le,{name:"slide-fade",mode:"out-in"},{default:se(()=>{var d,w;return[(n(),o("div",{key:p.value},[a("div",st,[a("h1",lt,b((d=j.value)==null?void 0:d.title),1),(w=j.value)!=null&&w.attribute_label?(n(),o("p",at,b(j.value.attribute_label),1)):I("",!0)]),j.value?(n(),o("div",rt,[a("div",nt,[(n(!0),o(D,null,z(e(j.value.items||[]),i=>(n(),ae(re,{key:i.qid,item:i,"model-value":x[i.qid],error:_[i.qid],disabled:y.value,"onUpdate:modelValue":c=>Y(i.qid,c),class:"mb-4"},null,8,["item","model-value","error","disabled","onUpdate:modelValue"]))),128))]),(n(!0),o(D,null,z(j.value.sections||[],i=>(n(),o("div",{key:i.section_id,class:"mb-5 p-4 bg-light rounded-3 border-start border-4 border-primary"},[i.title?(n(),o("h2",ot,b(i.title),1)):I("",!0),(n(!0),o(D,null,z(e(i.items||[]),c=>(n(),ae(re,{key:c.qid,item:c,"model-value":x[c.qid],error:_[c.qid],disabled:y.value,"onUpdate:modelValue":v=>Y(c.qid,v),class:"mb-4"},null,8,["item","model-value","error","disabled","onUpdate:modelValue"]))),128))]))),128))])):I("",!0)]))]}),_:1}),a("div",it,[a("button",{class:"btn btn-outline-secondary rounded-pill px-4",disabled:p.value===0||y.value,onClick:de},[...t[4]||(t[4]=[a("i",{class:"bi bi-arrow-left me-1"},null,-1),M(" Previous ",-1)])],8,ut),a("div",dt,[a("div",ct,[$.value.status==="saving"?(n(),o("small",mt,"Saving...")):$.value.status==="saved"?(n(),o("small",vt,"Saved "+b($.value.timestamp),1)):$.value.status==="error"?(n(),o("small",bt,"Autosave failed")):I("",!0)]),R.value?(n(),o("button",{key:1,class:"btn btn-success rounded-pill px-4 shadow-sm text-white",disabled:y.value,onClick:me},[y.value?(n(),o("span",yt)):I("",!0),t[6]||(t[6]=M(" Submit Survey ",-1))],8,pt)):(n(),o("button",{key:0,class:"btn btn-primary rounded-pill px-4 shadow-sm",disabled:y.value,onClick:ce},[...t[5]||(t[5]=[M(" Next ",-1),a("i",{class:"bi bi-arrow-right ms-1"},null,-1)])],8,ft))])])])])]))]),_:1})]))}},Vt=ne(ht,[["__scopeId","data-v-3feba0f0"]]);export{Vt as default};
