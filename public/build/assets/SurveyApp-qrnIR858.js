import{c as f,r as V,m as Z,a as i,o as r,b as a,d as I,t as b,e as M,q as be,y as fe,F,h as W,k as se,p as pe,i as X,f as O,g as le,j as ye,A as ae,s as ne}from"./app-BeGgamdR.js";import{_ as oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{S as Q}from"./SkeletonLoader-DsZlrgnT.js";import{u as he}from"./useToast-3pCS-Upl.js";const ge={class:"mb-4"},xe={class:"form-label text-dark fw-bold mb-2 d-block"},_e={key:0,class:"text-muted small mb-3"},ke={key:1,class:"bg-light p-4 rounded-3 border-0"},we={class:"d-flex justify-content-between text-muted small fw-bold text-uppercase mb-3"},Ve={key:0},qe=["min","max","step","disabled"],Se={class:"d-flex justify-content-center mt-3"},$e={class:"badge bg-primary rounded-pill px-3 py-2 fs-6 shadow-sm"},je=["type","value","disabled"],Ae=["value","disabled"],Ie=["value","disabled","min"],Pe=["value","disabled"],Te=["value"],Ne={key:0,class:"mt-3"},Ce=["placeholder","value","disabled"],Ee={key:6,class:"d-flex flex-column gap-2"},Oe=["id","value","checked","disabled","onChange"],Ue=["for"],Me=["value","disabled"],Fe={key:8,class:"alert alert-danger border-0 bg-danger bg-opacity-10 text-danger d-flex align-items-center mt-2 py-2 px-3 rounded-3"},De={__name:"SurveyItem",props:{item:{type:Object,required:!0},modelValue:{default:null},error:{type:String,default:""},disabled:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(c,{emit:D}){const u=c,q=D,g=f(()=>u.item.options||[]),N=f(()=>{const e={min:1,max:5,step:1};return u.item.scale?{...e,...u.item.scale}:e}),P=f(()=>{var e,l,h;return{left:((e=u.item.scale)==null?void 0:e.left_label)??"Low",right:((l=u.item.scale)==null?void 0:l.right_label)??"High",mid:((h=u.item.scale)==null?void 0:h.mid_label)??null}}),S=V(p());Z(()=>u.modelValue,e=>{u.item.type==="slider"&&e!==void 0&&e!==null&&e!==""&&(S.value=Number(e))}),Z(()=>S.value,e=>{u.item.type==="slider"&&q("update:modelValue",e)});function p(){if(u.modelValue!==null&&u.modelValue!==void 0)return Number(u.modelValue);const e=N.value.min??1,l=N.value.max??5;return Math.round((e+l)/2)}const x=f(()=>u.modelValue??""),_=f(()=>u.modelValue??""),j=f(()=>{var e;return((e=u.item.response)==null?void 0:e.format_hint)==="email"?"email":"text"}),L=f(()=>{var l;const e=(l=u.item.response)==null?void 0:l.min;return Number.isFinite(Number(e))?Number(e):void 0}),y=f(()=>u.item.type==="single_select_text"&&u.modelValue&&typeof u.modelValue=="object"?u.modelValue.selected??"":u.modelValue??""),C=f(()=>u.item.type==="single_select_text"&&u.modelValue&&typeof u.modelValue=="object"?u.modelValue.text??"":""),T=e=>Object.prototype.hasOwnProperty.call((e==null?void 0:e.meta)??{},"freetext_placeholder"),H=f(()=>{var h;const e=g.value.find(n=>n.value===y.value);if(!T(e))return"Please specify";const l=(h=e.meta)==null?void 0:h.freetext_placeholder;return l===""?"Please specify":l??"Please specify"}),z=f(()=>{const e=g.value.find(l=>l.value===y.value);return u.item.type==="single_select_text"&&T(e)}),A=f(()=>Array.isArray(u.modelValue)?u.modelValue:[]),E=f(()=>g.value.filter(e=>e.exclusive).map(e=>e.value)),R=e=>q("update:modelValue",e),ee=e=>{q("update:modelValue",e===""?null:Number(e))},G=e=>{var l;if(u.item.type==="single_select_text"){const h=g.value.find(n=>n.value===e);T(h)?q("update:modelValue",{selected:e,text:((l=u.modelValue)==null?void 0:l.text)??""}):q("update:modelValue",e)}else q("update:modelValue",e)},J=e=>{q("update:modelValue",{selected:y.value,text:e})},Y=e=>{const l=Array.isArray(u.modelValue)?[...u.modelValue]:[],h=l.includes(e.value);let n;e.exclusive?n=h?[]:[e.value]:(n=l.filter(U=>!E.value.includes(U)),h?n=n.filter(U=>U!==e.value):n.push(e.value)),q("update:modelValue",n)};return(e,l)=>{var h;return r(),i("div",ge,[a("label",xe,b(c.item.question),1),(h=c.item.metadata)!=null&&h.note?(r(),i("p",_e,[l[7]||(l[7]=a("i",{class:"bi bi-info-circle me-1"},null,-1)),M(" "+b(c.item.metadata.note),1)])):I("",!0),c.item.type==="slider"?(r(),i("div",ke,[a("div",we,[a("span",null,b(P.value.left),1),P.value.mid?(r(),i("span",Ve,b(P.value.mid),1)):I("",!0),a("span",null,b(P.value.right),1)]),be(a("input",{type:"range",class:"form-range custom-range",min:N.value.min,max:N.value.max,step:N.value.step||1,"onUpdate:modelValue":l[0]||(l[0]=n=>S.value=n),disabled:c.disabled},null,8,qe),[[fe,S.value,void 0,{number:!0}]]),a("div",Se,[a("span",$e," Selected: "+b(S.value),1)])])):c.item.type==="text_short"||c.item.type==="text"?(r(),i("input",{key:2,type:j.value,class:"form-control form-control-lg shadow-sm",value:x.value,disabled:c.disabled,onInput:l[1]||(l[1]=n=>R(n.target.value)),placeholder:"Type your answer here..."},null,40,je)):c.item.type==="text_long"?(r(),i("textarea",{key:3,class:"form-control form-control-lg shadow-sm",rows:"4",value:x.value,disabled:c.disabled,onInput:l[2]||(l[2]=n=>R(n.target.value)),placeholder:"Type your answer here..."},null,40,Ae)):c.item.type==="number_integer"?(r(),i("input",{key:4,type:"number",class:"form-control form-control-lg shadow-sm",value:_.value,disabled:c.disabled,min:L.value,step:"1",onInput:l[3]||(l[3]=n=>ee(n.target.value)),placeholder:"0"},null,40,Ie)):c.item.type==="dropdown"||c.item.type==="single_select"||c.item.type==="single_select_text"?(r(),i(F,{key:5},[a("select",{class:"form-select form-select-lg shadow-sm",value:y.value,disabled:c.disabled,onChange:l[4]||(l[4]=n=>G(n.target.value))},[l[8]||(l[8]=a("option",{value:"",disabled:""},"Select an option",-1)),(r(!0),i(F,null,W(g.value,n=>(r(),i("option",{key:n.value,value:n.value},b(n.label),9,Te))),128))],40,Pe),z.value?(r(),i("div",Ne,[a("input",{type:"text",class:"form-control form-control-lg shadow-sm",placeholder:H.value,value:C.value,disabled:c.disabled,onInput:l[5]||(l[5]=n=>J(n.target.value))},null,40,Ce)])):I("",!0)],64)):c.item.type==="multi_select"?(r(),i("div",Ee,[(r(!0),i(F,null,W(g.value,n=>(r(),i("div",{key:n.value,class:"form-check custom-checkbox p-3 border rounded-3 bg-white shadow-sm hover-bg transition-all"},[a("input",{class:"form-check-input me-2",type:"checkbox",id:c.item.qid+"-"+n.value,value:n.value,checked:A.value.includes(n.value),disabled:c.disabled,onChange:U=>Y(n),style:{transform:"scale(1.2)"}},null,40,Oe),a("label",{class:"form-check-label w-100 stretched-link",for:c.item.qid+"-"+n.value,style:{cursor:"pointer"}},b(n.label),9,Ue)]))),128))])):(r(),i("input",{key:7,type:"text",class:"form-control form-control-lg shadow-sm",value:x.value,disabled:c.disabled,onInput:l[6]||(l[6]=n=>R(n.target.value))},null,40,Me)),c.error?(r(),i("div",Fe,[l[9]||(l[9]=a("i",{class:"bi bi-exclamation-circle-fill me-2"},null,-1)),M(" "+b(c.error),1)])):I("",!0)])}}},re=oe(De,[["__scopeId","data-v-223d0388"]]),Le={class:"survey-container mx-auto",style:{"max-width":"800px"}},Re={class:"text-center py-5",key:"loading"},Be={class:"card border-0 shadow-sm rounded-4 p-5"},Qe={class:"d-flex justify-content-center gap-3"},We={class:"alert alert-danger shadow-sm border-0 rounded-3",key:"error"},He={key:"completed"},Je={class:"card border-0 shadow-lg rounded-4 overflow-hidden"},Ye={class:"card-body text-center py-5 px-4"},ze={key:0,class:"text-muted mb-4 lead"},Ge={key:1,class:"text-muted mb-4 lead"},Ke={key:"survey"},Xe={class:"mb-4 px-1"},Ze={class:"d-flex justify-content-between text-muted small mb-2 fw-semibold"},et={class:"progress",style:{height:"6px","background-color":"#e9ecef"}},tt={class:"card border-0 shadow-lg rounded-4"},st={class:"card-body p-4 p-md-5"},lt={class:"mb-4 border-bottom pb-3"},at={class:"h4 fw-bold mb-2 text-primary"},nt={key:0,class:"text-muted mb-0"},rt={key:0,class:"survey-content"},ot={class:"mb-4"},it={key:0,class:"h5 fw-bold mb-3 text-dark"},ut={class:"d-flex justify-content-between align-items-center mt-5 pt-3 border-top"},dt=["disabled"],ct={class:"d-flex align-items-center gap-3"},mt={class:"d-none d-md-block text-end me-2"},vt={key:0,class:"text-muted d-block lh-1"},bt={key:1,class:"text-muted d-block lh-1"},ft={key:2,class:"text-danger d-block lh-1"},pt=["disabled"],yt=["disabled"],ht={key:0,class:"spinner-border spinner-border-sm me-2",role:"status"},gt={__name:"SurveyApp",props:{definitionUrl:{type:String,required:!0},submitUrl:{type:String,required:!0},autosaveUrl:{type:String,required:!0}},setup(c){const D=c,u=he(),q=V(!0),g=V(null),N=V(null),P=V(null),S=V([]),p=V(0),x=se({}),_=se({}),j=V({status:"idle",timestamp:null}),L=V(null),y=V(!1),C=V(!1),T=V(!1),H=V(!1),z=Date.now(),A=f(()=>S.value[p.value]??null),E=f(()=>S.value.length),R=f(()=>p.value===E.value-1);pe(async()=>{q.value=!0,g.value=null;try{const{data:s}=await X.get(D.definitionUrl);N.value=s.version,P.value=s.assignment,S.value=s.pages||[],p.value=0,T.value=P.value.status==="completed",C.value=T.value,Object.keys(x).forEach(d=>delete x[d]);const t=P.value.draft_answers||{};Object.entries(t).forEach(([d,w])=>{x[d]=w}),H.value=!0}catch(s){console.error(s),g.value="Unable to load the survey right now. Please try again later.",u.error("Failed to load survey data.")}finally{q.value=!1}}),Z(x,()=>{!H.value||C.value||G()},{deep:!0});const G=()=>{clearTimeout(L.value),L.value=setTimeout(async()=>{try{j.value={status:"saving",timestamp:null},await X.post(D.autosaveUrl,{responses:J()}),j.value={status:"saved",timestamp:new Date().toLocaleTimeString()}}catch(s){console.error("Autosave failed",s),j.value={status:"error",timestamp:null},u.error("Autosave failed. Please check your connection.")}},1e3)},J=()=>JSON.parse(JSON.stringify(x)),Y=(s,t)=>{x[s]=t,_[s]=null},e=(s=[])=>s.filter(t=>l(t)),l=s=>{const t=s.display_logic;if(!t||Array.isArray(t)&&t.length===0)return!0;const d=Array.isArray(t)?t:t.when??[];if(!d.length)return!0;const w=m=>{const v=x[m.qid];if(v==null||v==="")return!1;const k=m.equals_any||[];if(!k.length)return!0;if(Array.isArray(v))return v.some($=>k.includes($));if(typeof v=="object"){const $=v.selected??v.value??v.text??"";return k.includes($)}return k.includes(v)},o=String((t==null?void 0:t.operator)??(t==null?void 0:t.combinator)??"and").toLowerCase();return o==="or"||o==="any"?d.some(w):d.every(w)},h=s=>{var t;return((t=s==null?void 0:s.response)==null?void 0:t.required)!==!1&&["slider","single_select","single_select_text","dropdown","multi_select","number_integer","text_short","text","text_long"].includes(s.type)},n=s=>s==null||s===""?!0:Array.isArray(s)?s.length===0:typeof s=="object"?Object.keys(s).filter(d=>s[d]!==void 0&&s[d]!=="").length===0:!1,U=s=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s).trim()),ie=s=>{var d;const t=(d=s==null?void 0:s.response)==null?void 0:d.min;return Number.isFinite(Number(t))?Number(t):null},ue=()=>{const s=[];return(S.value||[]).forEach(t=>{e(t.items||[]).forEach(d=>s.push(d.qid)),(t.sections||[]).forEach(d=>{e(d.items||[]).forEach(w=>s.push(w.qid))})}),new Set(s)},de=()=>{const s=J(),t=ue();return Object.fromEntries(Object.entries(s).filter(([d])=>t.has(d)))},te=()=>{const s=A.value;if(!s)return!0;let t=!0;const d=(s.sections||[]).flatMap(o=>e(o.items||[]));return[...e(s.items||[]),...d].forEach(o=>{var v;const m=x[o.qid];if(h(o)&&n(m)){_[o.qid]="Please provide an answer.",t=!1;return}if(o.type==="single_select_text"&&m&&typeof m=="object"&&m.selected&&(!m.text||String(m.text).trim()==="")){_[o.qid]="Please provide the additional text.",t=!1;return}if((o.type==="text_short"||o.type==="text"||o.type==="text_long")&&((v=o==null?void 0:o.response)==null?void 0:v.format_hint)==="email"&&!n(m)&&!U(m)){_[o.qid]="Please enter a valid email address.",t=!1;return}if(o.type==="number_integer"&&!n(m)){const k=Number(m);if(!Number.isInteger(k)){_[o.qid]="Please enter a whole number.",t=!1;return}const $=ie(o);if($!==null&&k<$){_[o.qid]=`Value must be at least ${$}.`,t=!1;return}}_[o.qid]=null}),t},ce=()=>{p.value===0||y.value||(p.value-=1)},me=()=>{!te()||y.value||p.value<E.value-1&&(p.value+=1)},ve=async()=>{var s,t;if(te()){y.value=!0,g.value=null,clearTimeout(L.value);try{await X.post(D.submitUrl,{responses:de(),duration_ms:Date.now()-z}),C.value=!0}catch(d){if(d.response&&d.response.status===409)C.value=!0,T.value=!0;else if(d.response&&d.response.status===422){const w=((t=(s=d.response)==null?void 0:s.data)==null?void 0:t.errors)||{};Object.keys(_).forEach(v=>{_[v]=null}),Object.entries(w).forEach(([v,k])=>{const $=v.startsWith("responses.")?v.slice(10):v,K=Array.isArray(k)?k[0]:k;_[$]=K||"Invalid answer."});const o=Object.keys(w)[0],m=o?o.startsWith("responses.")?o.slice(10):o:null;if(m){const v=S.value.findIndex(k=>{const $=e(k.items||[]).map(B=>B.qid),K=(k.sections||[]).flatMap(B=>e(B.items||[])).map(B=>B.qid);return[...$,...K].includes(m)});v>=0&&(p.value=v)}g.value="Please correct the highlighted responses and submit again."}else console.error(d),g.value="Something went wrong while submitting your responses. Please try again."}finally{y.value=!1}}};return(s,t)=>(r(),i("div",Le,[O(ae,{name:"fade",mode:"out-in"},{default:le(()=>[q.value?(r(),i("div",Re,[a("div",Be,[O(Q,{height:"2rem",width:"60%",class:"mb-4 mx-auto"}),O(Q,{height:"1rem",width:"80%",class:"mb-2 mx-auto"}),O(Q,{height:"1rem",width:"70%",class:"mb-4 mx-auto"}),a("div",Qe,[O(Q,{height:"3rem",width:"120px",borderRadius:"2rem"}),O(Q,{height:"3rem",width:"120px",borderRadius:"2rem"})])])])):g.value?(r(),i("div",We,[t[0]||(t[0]=a("i",{class:"bi bi-exclamation-circle-fill me-2"},null,-1)),M(" "+b(g.value),1)])):C.value?(r(),i("div",He,[a("div",Je,[a("div",Ye,[t[1]||(t[1]=a("div",{class:"mb-4"},[a("div",{class:"bg-success bg-opacity-10 text-success rounded-circle d-inline-flex align-items-center justify-content-center",style:{width:"80px",height:"80px"}},[a("i",{class:"bi bi-check-lg display-4"})])],-1)),t[2]||(t[2]=a("h1",{class:"h3 fw-bold mb-3"},"Thank you!",-1)),T.value?(r(),i("p",ze," You have already submitted this survey. We appreciate your time. ")):(r(),i("p",Ge," Your responses have been recorded successfully. ")),t[3]||(t[3]=a("a",{href:"/",class:"btn btn-primary rounded-pill px-4 py-2"},"Return to Home",-1))])])])):(r(),i("div",Ke,[a("div",Xe,[a("div",Ze,[a("span",null,"Page "+b(p.value+1)+" of "+b(E.value),1),a("span",null,b(Math.round((p.value+1)/E.value*100))+"% Completed",1)]),a("div",et,[a("div",{class:"progress-bar bg-primary rounded-pill",role:"progressbar",style:ye({width:`${(p.value+1)/E.value*100}%`})},null,4)])]),a("div",tt,[a("div",st,[O(ae,{name:"slide-fade",mode:"out-in"},{default:le(()=>{var d,w;return[(r(),i("div",{key:p.value},[a("div",lt,[a("h1",at,b((d=A.value)==null?void 0:d.title),1),(w=A.value)!=null&&w.attribute_label?(r(),i("p",nt,b(A.value.attribute_label),1)):I("",!0)]),A.value?(r(),i("div",rt,[a("div",ot,[(r(!0),i(F,null,W(e(A.value.items||[]),o=>(r(),ne(re,{key:o.qid,item:o,"model-value":x[o.qid],error:_[o.qid],disabled:y.value,"onUpdate:modelValue":m=>Y(o.qid,m),class:"mb-4"},null,8,["item","model-value","error","disabled","onUpdate:modelValue"]))),128))]),(r(!0),i(F,null,W(A.value.sections||[],o=>(r(),i("div",{key:o.section_id,class:"mb-5 p-4 bg-light rounded-3 border-start border-4 border-primary"},[o.title?(r(),i("h2",it,b(o.title),1)):I("",!0),(r(!0),i(F,null,W(e(o.items||[]),m=>(r(),ne(re,{key:m.qid,item:m,"model-value":x[m.qid],error:_[m.qid],disabled:y.value,"onUpdate:modelValue":v=>Y(m.qid,v),class:"mb-4"},null,8,["item","model-value","error","disabled","onUpdate:modelValue"]))),128))]))),128))])):I("",!0)]))]}),_:1}),a("div",ut,[a("button",{class:"btn btn-outline-secondary rounded-pill px-4",disabled:p.value===0||y.value,onClick:ce},[...t[4]||(t[4]=[a("i",{class:"bi bi-arrow-left me-1"},null,-1),M(" Previous ",-1)])],8,dt),a("div",ct,[a("div",mt,[j.value.status==="saving"?(r(),i("small",vt,"Saving...")):j.value.status==="saved"?(r(),i("small",bt,"Saved "+b(j.value.timestamp),1)):j.value.status==="error"?(r(),i("small",ft,"Autosave failed")):I("",!0)]),R.value?(r(),i("button",{key:1,class:"btn btn-success rounded-pill px-4 shadow-sm text-white",disabled:y.value,onClick:ve},[y.value?(r(),i("span",ht)):I("",!0),t[6]||(t[6]=M(" Submit Survey ",-1))],8,yt)):(r(),i("button",{key:0,class:"btn btn-primary rounded-pill px-4 shadow-sm",disabled:y.value,onClick:me},[...t[5]||(t[5]=[M(" Next ",-1),a("i",{class:"bi bi-arrow-right ms-1"},null,-1)])],8,pt))])])])])]))]),_:1})]))}},Vt=oe(gt,[["__scopeId","data-v-dafc7ac3"]]);export{Vt as default};
