# Empulse (Workfitdx) - Replit Setup

## Overview
Multi-tenant Laravel 11 application with Vue.js frontend for company onboarding, employee management, survey engine, and Stripe subscriptions.

## Recent Changes (November 19-24, 2025)
- ‚úÖ Imported from GitHub and configured for Replit environment
- ‚úÖ Installed PHP 8.2 and Composer dependencies  
- ‚úÖ Installed Node.js dependencies and built frontend assets
- ‚úÖ Configured Vite for production builds (HMR disabled, manifest at correct location)
- ‚úÖ Set up SQLite database and ran all 39 migrations successfully
- ‚úÖ Configured TrustProxies middleware to trust Replit's proxy (`$proxies = '*'`)
- ‚úÖ Created RewriteAssetUrls middleware to convert absolute asset URLs to relative paths
- ‚úÖ Fixed layouts/app.blade.php to include @yield('content') for guest users
- ‚úÖ Fixed Vue.js mounting to be conditional (only for authenticated users, not guest landing page)
- ‚úÖ Set up Laravel dev server workflow on port 5000
- ‚úÖ Configured autoscale deployment with build step
- ‚úÖ Landing page fully functional with Bootstrap styling and dashboard preview
- ‚úÖ Completely redesigned authentication system with modern Bootstrap 5 styling:
  - Login page with split-panel design and Google OAuth
  - Register page with comprehensive form and trial benefits
  - Password reset email request page
  - Password reset form page
  - Password confirmation page
  - Email verification page
- ‚úÖ Added Bootstrap Icons CDN for professional icon support across all pages
- ‚úÖ All guest-facing authentication pages now have consistent purple gradient design
- ‚úÖ **November 24 Security Audit & Fixes:**
  - Fixed RegisterController duplicate trait import (fatal error)
  - Hardened AnalyticsApiController tenant authorization
  - Created UserRole enum for type-safe role management
  - Added login_url/test_url configuration with sensible defaults
  - Replaced env() calls with config() in TeamController
  - ‚ö†Ô∏è **Remaining Security Issues** (see Technical Debt section below)

## Project Architecture

### Stack
- **Backend**: Laravel 11 (PHP 8.2)
- **Frontend**: Vue.js 3 with Vite
- **Database**: SQLite (development), PostgreSQL (production recommended)
- **Styles**: Bootstrap 5, SASS
- **Charts**: Chart.js, vue-chartjs
- **Payments**: Stripe via Laravel Cashier

### Key Directories
- `app/` - Laravel application code (Models, Controllers, Services)
- `resources/js/components/` - Vue.js components (dashboard, survey, reports, etc.)
- `resources/views/` - Blade templates
- `public/build/` - Built frontend assets (generated by Vite)
- `database/migrations/` - Database schema migrations
- `routes/` - Application routes (web, API, console)

## Configuration for Replit

### Database Configuration (IMPORTANT)
**The application uses PostgreSQL, NOT SQLite, despite what .env says:**
- `.env` file shows `DB_CONNECTION=sqlite` (legacy config)
- **Actual database**: PostgreSQL 16.10 via `DATABASE_URL` environment variable
- `DATABASE_URL` overrides `.env` settings (this is correct behavior)
- Database host: `helium` (Replit's internal PostgreSQL service)
- **29 tables** migrated, **7 test users** seeded
- **DO NOT** change this - PostgreSQL is production-grade and already working

**To seed fresh test data:**
```bash
php artisan db:seed
```
This creates test accounts for all roles (Admin, Manager, Chief, Team Lead, Employees).

### Dynamic URL Handling
The application automatically detects and uses the URL it's accessed from, thanks to the `AppServiceProvider` configuration. This means:
- Assets automatically use the correct URL (whether localhost, Replit proxy, or custom domain)
- No manual APP_URL configuration needed for basic functionality
- Works seamlessly behind Replit's HTTPS proxy

### Required Environment Configuration (Production)

For production deployment, you'll need to set these environment variables:

1. **Database** - Switch from SQLite to PostgreSQL:
   - Use Replit's PostgreSQL database feature
   - Update .env with database credentials
   - Run migrations: `php artisan migrate`

2. **Mail Service** (Required for survey invitations):
   ```
   MAIL_MAILER=smtp
   MAIL_HOST=smtp.brevo.com
   MAIL_PORT=587
   MAIL_USERNAME=your-username
   MAIL_PASSWORD=your-password
   MAIL_FROM_ADDRESS=noreply@yourdomain.com
   ```

3. **Stripe** (Required for subscriptions):
   ```
   STRIPE_KEY=pk_test_...
   STRIPE_SECRET=sk_test_...
   STRIPE_WEBHOOK_SECRET=whsec_...
   ```

4. **Social Authentication** (Optional):
   - Google: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`
   - Facebook: `FACEBOOK_CLIENT_ID`, `FACEBOOK_CLIENT_SECRET`

### Proxy Configuration
The `app/Http/Middleware/TrustProxies.php` is configured to trust all proxies (`$proxies = '*'`), which is required for Replit's infrastructure.

### Vite Configuration
Production builds (`npm run build`) automatically disable HMR to avoid WebSocket issues. The build creates optimized assets in `public/build/`.

## Development Workflow

### Running the Application
1. The Laravel server runs automatically on port 5000
2. Access your app through the Replit webview
3. Frontend assets are pre-built and ready to use

### Making Frontend Changes
```bash
npm run build
```
After making changes to Vue components or SASS files, rebuild the assets.

### Database Operations
```bash
php artisan migrate          # Run migrations
php artisan db:seed         # Seed database  
php artisan storage:link    # Link storage (already done)
```

### Queue & Scheduler (For Survey Automation)
Survey waves require background processing:
```bash
php artisan queue:work --tries=1
```

## Deployment

Configured for autoscale deployment with:
- **Build**: `npm run build` (compiles frontend assets)
- **Run**: `php artisan serve --host=0.0.0.0 --port=5000`

### Pre-Deployment Checklist
- [ ] Set APP_ENV to "production"
- [ ] Set APP_DEBUG to "false"
- [ ] Configure PostgreSQL database
- [ ] Run all migrations
- [ ] Configure Stripe keys
- [ ] Set up mail service
- [ ] Optimize: `php artisan config:cache` and `php artisan route:cache`

## Features

### Survey System
- Built-in survey builder with drag-and-drop interface
- Multiple question types (text, scale, multiple choice, etc.)
- Wave-based deployment with automated drip cadences
- Real-time response tracking and analytics
- Dashboard with charts and reports

### User Management
- Role-based access: Admin, Manager, Chief, Team Lead, Employee
- Company and department hierarchy
- CSV/XLSX import/export for bulk operations
- Team member invitation system

### Billing & Subscriptions
- Stripe integration via Laravel Cashier
- Multiple subscription tiers
- Automatic access control based on subscription status
- Billing dashboard for admins

## Troubleshooting

### General Issues
- **Config changes not taking effect**: Run `php artisan config:clear`
- **View changes not showing**: Run `php artisan view:clear`
- **Routes not found**: Run `php artisan route:clear`

### Database Issues
- SQLite file: `database/database.sqlite`
- Check file exists and has write permissions
- For PostgreSQL: Verify credentials in .env

### Asset/Build Issues
- Rebuild assets: `npm run build`
- Check `public/build/` directory exists
- Ensure Vite manifest exists: `public/build/manifest.json`

## Technical Debt & Security Concerns

### üö® Critical Issues Requiring Attention Before Production

**1. Privilege Escalation Vulnerability**
- `UserService::checkStatus()` and role assignment use string matching
- Attackers could craft status strings to gain elevated permissions
- **Fix Required**: Integrate `UserRole` enum and validate role assignments

**2. Data Integrity Risk**
- User creation/update operations span multiple tables without transactions
- Partial failures can create inconsistent data (users without company_worker records, etc.)
- **Fix Required**: Wrap all UserService mutators in `DB::transaction` blocks

**3. Missing Authorization Policies**
- TeamController mutations lack Laravel authorization gates
- No server-side validation for role escalation attempts
- **Fix Required**: Create authorization policies for user management operations

**4. UserRole Enum Not Integrated**
- Created `app/Enums/UserRole.php` but not yet wired into existing code
- Legacy magic numbers (0, 1, 2, 3, 4) still used throughout
- **Fix Required**: Replace all role integer literals with enum references

### Development vs Production Status

‚úÖ **Ready for Development/Testing:**
- All features functional
- Modern UI/UX across authentication and dashboards
- Database schema stable
- Test accounts working

‚ùå **Not Yet Production-Ready:**
- Critical security vulnerabilities remain
- Stripe integration incomplete (missing live keys)
- Brevo email not configured
- Transaction safety needed for data integrity

## Notes
- The application uses an internal survey engine (Qualtrics fully replaced)
- Survey automation requires queue workers and scheduler
- See `docs/AUDIT.md` for detailed audit and roadmap
- Laravel 11 uses streamlined bootstrap in `bootstrap/app.php`

## Next Steps
1. **Test the application**: Access it through the Replit webview
2. **Set up database**: Consider PostgreSQL for production
3. **Configure Stripe**: Add your Stripe API keys for subscriptions
4. **Configure mail**: Set up SMTP for survey invitations
5. **Review features**: Explore the survey builder and dashboard

## User Preferences
- Not yet configured

## Technical Details

### How Dynamic URL Works
The `AppServiceProvider::boot()` method checks if the app is running in web context and automatically sets the app URL from the incoming request. This ensures:
- Vite assets use the correct domain
- URLs work correctly behind proxies
- No hardcoded localhost URLs in production

### Build Process
Frontend assets are compiled with Vite in production mode:
- HMR is disabled for production builds
- Assets are fingerprinted for cache busting
- Source maps are excluded
- Code is minified and optimized
